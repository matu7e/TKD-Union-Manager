<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>Unión Mediterránea - Taekwondo IFT</title>
    <link rel="shortcut icon" href="../assets/union.ico" type="image/x-icon">
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="stylesheet" href="../styles/footer.css">
    <link rel="stylesheet" href="../styles/menu.css">
    <link rel="stylesheet" href="../styles/modal_conf.css">
    <link rel="stylesheet" href="../styles/ABM_publicaciones.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
</head>
<style>
.img-circular-container {
    display: flex;
    justify-content: center; /* Centra la imagen horizontalmente */
    margin-top: 10px; /* Espacio entre el input y la imagen */
}

.img-circular {
    width: 250px; /* Ancho de la imagen */
    height: 250px; /* Alto de la imagen */
    border-radius: 50%; /* Hace que la imagen sea circular */
    object-fit: cover; /* Recorta la imagen para que encaje en el contenedor */
    border: 2px solid #ccc; /* Bordes opcionales para la imagen */
}

.container {
    text-align: center;
    max-width: 1500px;
    padding: 50px;
    border-radius: 30px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
    margin: 150px auto;
    flex: 1;
}

.search-filters {
    background-color: #63666B;
    padding: 20px;
    border-radius: 20px;
    margin: 0 auto;
    height: auto;  /* Ajusta la altura automáticamente */
    align-content: center;
}

.filter-row {
    display: flex;
    justify-content: flex-end;  /* Cambiado a 'flex-start' para alinear a la izquierda */
    padding-bottom: 15px;
    margin: 15px;
}

.filter-group {
    flex: 1;
    margin-right: 10px;
}

.filter-group:last-child {
    margin-right: 0;
}

label {
    display: block;
    color: #fff;
    margin-bottom: 5px;
    text-align: initial;
}

input[type="text"],
select {
    width: 100%;
    padding: 16px;
    background-color: #d5d7d8;
    border: none;
    border-radius: 5px;
    font-size: 14px;
}

input[type="text"]:focus,
select:focus {
    outline: none;
}

.search-button {
    background-color: #323232;
    color: white;
    padding: 15px 50px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    text-align: center;
    display: block;
}

.search-button:hover {
    background-color: #f36a2bc2;
}


h2, h3{
    margin: 30px;
    margin-bottom: 30px;
    font-size: 40px;
    text-align: left;
    margin-bottom: 50px;
}
h3{
    color: #D2D2D2;
}




</style>
<body>
    <header class="navbar">
        <div class="navbar-left">
            <a href="../Index.html">
                <img src="../assets/log4.png" alt="Logo" class="navbar-logo">
                <h1 class="navbar-title">PANEL DE ADMINISTRACION</h1>
            </a>
        </div>
        <nav class="navbar-menu" id="navbar-menu">
            <ul>
                <img src="../assets/log1.png" alt="Logo" class="navbar-logo-U">
                <li><a href="publicaciones.html">Publicaciones</a></li>
                <li><a href="ABM_alumnos.html">Mis alumnos</a></li> 
                <li><a id="actual" href="ABM_escuelas.html">Mi escuela</a></li>
                <li><a href="mi-perfil.html">Mi perfil</a></li>
                <li><a href="../src/login.html" class="login-btn">Cerrar Sesión</a></li>
            </ul>
        </nav>
        <i class="fas fa-bars hamburger" id="hamburger"></i>
    </header>       
    <!-- Loader -->
    <!-- <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div> -->
    <div class="alert-container">
        <div id="alert-aviso" class="alert alert-aviso">            
        </div>
        <div id="alert-success" class="alert alert-success">            
        </div>
        <div id="alert-error" class="alert alert-danger">
        </div>
    </div>
    
    <main class="container">
        <h2>Escuela</h2>
        <button class="new-publication" id="openModalButton">Mi Escuela</button>
    
        <!-- Modal personalizado -->
        <div id="newPublicationModal" class="custom-modal">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h5 class="modal-title">Crear nueva escuela</h5>
                    <button class="btn-close-custom" id="closeModalButton">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="publicationForm">
                        <!-- Campo para el logo de la escuela con vista previa -->
                        <div class="mb-3 img-circular-container">
                            <img id="imagePreview" src="../../Backend/uploads/default/logo.png" alt="Vista previa" class="img-circular">
                        </div>
    
                        <!-- Campo para el nombre de la escuela -->
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="titulo" name="titulo" required>
                        </div>
    
                        <!-- Campo para el logo de la escuela -->
                        <div class="mb-3">
                            <label for="imagen" class="form-label">Logo de la escuela</label>
                            <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*" onchange="previewImage(event)">
                        </div>
    
                        <!-- Campo para el email -->
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Email</label>
                            <input type="email" class="form-control" id="descripcion" name="descripcion" required>
                        </div>
    
                        <!-- Campo para el teléfono -->
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" required>
                        </div>
    
                        <!-- Campo para el enlace de Instagram -->
                        <div class="mb-3">
                            <label for="enlaceInstagram" class="form-label">Instagram</label>
                            <input type="text" class="form-control" id="enlaceInstagram" name="enlaceInstagram" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-cancelar" id="closeModalButtonFooter">Cerrar</button>
                    <button type="button" class="btn btn-guardar" id="btnGuardar">Guardar</button>
                </div>
            </div>
        </div>
    
        <!-- Modal de Confirmación -->
        <div id="confirmModal" class="confirmacion-modal">
            <div class="modal-content-confirmacion">
                <div class="modal-header-confirmacion">
                    <h5 class="modal-title">Confirmación</h5>
                    <button class="btn-close-confirmacion" id="closeConfirmModal">&times;</button>
                </div>
                <div class="confirmacion-modal-body">
                    <p id="confirmMessage">¿Estás seguro de realizar esta acción?</p>
                </div>
                <div class="modal-footer-confirmacion">
                    <button type="button" class="btn btn-cancelar" id="cancelConfirmButton">Cancelar</button>
                    <button type="button" class="btn btn-confirmar" id="confirmActionButton">Confirmar</button>
                </div>
            </div>
        </div>

       
        <!-- Formulario reorganizado para crear sedes manteniendo las clases -->
        <section class="search-filters">
            <h3>Sedes</h3>
            <form action="#" method="POST" id="create-sede-form" novalidate>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="direccion">Dirección*</label>
                        <input type="text" id="direccion" name="direccion" placeholder="Ingresa la dirección" required />
                    </div>
        
                    <div class="filter-group">
                        <label for="descripcion">Descripción*</label>
                        <input type="text" id="descripcion" name="descripcion" placeholder="Ingresa la descripción" required />
                    </div>
                </div>
        
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="provincia">Provincia*</label>
                        <select id="provincia" name="provincia" required>
                            <option value="">Selecciona la provincia</option>
                            <!-- Opciones dinámicas de provincias -->
                        </select>
                    </div>
        
                    <div class="filter-group">
                        <label for="localidad">Localidad*</label>
                        <select id="localidad" name="localidad" required>
                            <option value="">Selecciona la localidad</option>
                            <!-- Opciones dinámicas de localidades -->
                        </select>
                    </div>
                </div>
        
                <div class="filter-row">
                    <button type="button" id="add-sede-button" class="search-button">Añadir</button>
                </div>
            </form>
        
            <div id="sedes-list"></div>
        </section>
        

    </main>
    

    <footer>
        <div class="footer">
            <div class="footer-content">
                <img src="../assets/union-logo.png" alt="Logo Unión Mediterránea de Taekwondo" class="footer-logo">
                <div class="footer-icons-container">
                    <div class="icon-arrow">
                        <a href="#"><i class="fa-solid fa-arrow-up"></i></a>
                    </div>
                    <div class="footer-icons">
                        <a target="_blank" href="https://www.facebook.com/p/Union-Mediterranea-de-Taekwondo-100063475813834/"><i class="fa-brands fa-facebook"></i></a>
                        <a target="_blank" href="https://www.instagram.com/union_mediterranea/"><i class="fa-brands fa-instagram"></i></a>
                        <a target="_blank" href="#"><i class="fa-brands fa-youtube"></i></a>
                        <a target="_blank" href="https://wa.me/3517014308"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                    <a href="mailto:supportunion@gmail.com" class="footer-email">supportunion@gmail.com</a>
                </div>
                <div class="footer-right">
                    <img src="../assets/fetra-logo.png" alt="Logo Federación Taekwondo" class="footer-logo">
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>UNION MEDITERRANEA DE TAEKWONDO 2024</p>
        </div>
    </footer>

    
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
    <script src="../controllers/public/menu.js"></script>
    
    <script>



        //-------------------------------------------------------------------------------------------
        //CUANDO SE HACE PUT NO SE ACTUALIZA EL LOGO CREO QUE ES POR COMO RECIVE EL IDESCUEAL EL FECH  
        //-------------------------------------------------------------------------------------------



        let idEscuela = null; // Variable para almacenar el ID de la escuela si existe

function submitForm() {
    const token = localStorage.getItem('authToken');
    if (!token) {
        redirectToLogin('Token no encontrado.');
        return;
    }

    const { dni } = jwt_decode(token);

    const nombre = document.getElementById('titulo').value;
    const email = document.getElementById('descripcion').value;
    const telefono = document.getElementById('telefono').value;
    const enlace = document.getElementById('enlaceInstagram').value;

    if (!nombre || !email || !telefono || !enlace) {
        alert('Por favor, complete todos los campos del formulario.');
        return;
    }

    // Data para enviar en el POST/PUT
    const data = {
        nombre,
        dni_instructor: dni,
        email,
        telefono,
        enlace,
    };

    async function fetchUserData() {
        try {
            let response;
            if (idEscuela) {
                console.log('Actualizando escuela existente con ID:', idEscuela);
                response = await fetch(`http://localhost:3000/escuelas/${idEscuela}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
            } else {
                console.log('Creando nueva escuela...');
                response = await fetch(`http://localhost:3000/escuelas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
            }

            const responseData = await response.text(); // Obtiene la respuesta como texto
            console.log('Respuesta del servidor:', responseData); // Log de la respuesta

            if (!response.ok) {
                alert('Error al realizar la acción: ' + responseData);
                return; // Salir de la función en caso de error
            }

            // Intentar analizar la respuesta como JSON
            let jsonData = null;
            try {
                jsonData = JSON.parse(responseData);
            } catch (e) {
                console.warn('La respuesta no es un JSON válido, manejando como texto:', responseData);
            }

            // Manejo de la respuesta
            if (jsonData && jsonData.message) {
                alert(jsonData.message);
                idEscuela = idEscuela || jsonData.id_escuela; // Asigna el ID de la escuela

                // Manejar la carga del logo
                const logoInput = document.getElementById('imagen');
                if (logoInput.files.length > 0) {
                    const logoFormData = new FormData();
                    logoFormData.append('logo', logoInput.files[0]);

                    console.log('Preparando carga del logo para la escuela ID:', idEscuela); // Log del ID de la escuela
                    const logoResponse = await fetch(`http://localhost:3000/escuelas/${idEscuela}/cargaLogo`, {
                        method: 'POST', // Se mantiene el POST para la carga del logo
                        body: logoFormData,
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // No se establece Content-Type aquí
                        }
                    });

                    if (logoResponse.ok) {
                        alert('Logo cargado con éxito');
                    } else {
                        const logoResponseText = await logoResponse.text();
                        alert('Error al cargar el logo: ' + logoResponseText);
                    }
                } else {
                    alert('No se ha seleccionado un logo para cargar.');
                }

                modal.style.display = 'none'; // Cerrar el modal al finalizar
            } else if (jsonData && jsonData.error) {
                alert('Error: ' + jsonData.error);
            } else {
                alert('Operación realizada: ' + responseData);
            }

        } catch (error) {
            console.error('Error en la petición:', error);
            alert('Se produjo un error al enviar los datos: ' + error.message);
        }
    }

    fetchUserData();
}



    
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            if (!token) {
                redirectToLogin('Token no encontrado.');
                return;
            }
    
            const { dni: idInstructor } = jwt_decode(token);
    
            async function cargarDatosEscuela() {
                try {
                    console.log('Iniciando GET para cargar datos de la escuela...');
                    const response = await fetch(`http://localhost:3000/escuelas/instructor/${idInstructor}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
    
                    const responseText = await response.text(); // Cambia a text en lugar de json
                    console.log('Respuesta completa del GET:', responseText);
    
                    if (!response.ok) {
                        if (responseText.includes("No se encontraron escuelas para ese instructor.")) {
                            console.log('No se encontró ninguna escuela para el instructor.');
                            return;
                        }
                        throw new Error('Error al cargar los datos de la escuela: ' + response.statusText);
                    }
    
                    const data = JSON.parse(responseText);
                    
                    if (Array.isArray(data) && data.length > 0) {
                        const escuela = data[0];
                        idEscuela = escuela.id_escuela; // Asigna el ID de la escuela
                        console.log('ID de la escuela encontrado:', idEscuela);
    
                        // Actualiza los campos del formulario si la escuela ya existe
                        document.getElementById('titulo').value = escuela.nombre || '';
                        document.getElementById('descripcion').value = escuela.email_escuela || '';
                        document.getElementById('telefono').value = escuela.telefono_escuela || '';
                        document.getElementById('enlaceInstagram').value = escuela.enlace || '';
                        document.getElementById('imagePreview').src = '../../Backend/' + (escuela.logo_escuela || 'uploads/default/logo.png');
                    } else {
                        console.log('No se encontró ningún registro en el array de respuesta.');
                    }
                
                } catch (error) {
                    console.error('Error al cargar datos de la escuela:', error);
                    alert('Se produjo un error al cargar los datos: ' + error.message);
                }
            }
    
            cargarDatosEscuela();
        });
    
        document.getElementById('confirmActionButton').addEventListener('click', submitForm);
    </script>
    
    
    
    
   
    
    
    <script src="../controllers/controllers-publicaciones/manejo-modales.js"></script>

    

        <script>
            // Función para cargar provincias desde el backend
            async function cargarProvincias() {
                try {
                    const response = await fetch('http://localhost:3000/georef');
                    if (!response.ok) throw new Error('Error al obtener las provincias');
            
                    const provincias = await response.json();
                    const selectProvincia = document.getElementById('provincia');
                    selectProvincia.innerHTML = '<option value="">Seleccione una provincia</option>';
            
                    provincias.forEach(provincia => {
                        const option = document.createElement('option');
                        option.value = provincia.id;
                        option.textContent = provincia.nombre;
                        selectProvincia.appendChild(option);
                    });
            
                    // Evento para cargar localidades cuando se selecciona una provincia
                    selectProvincia.addEventListener('change', async (event) => {
                        const provinciaId = event.target.value;
                        if (provinciaId) await cargarLocalidades(provinciaId);
                    });
            
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            
            // Función para cargar localidades de una provincia
            async function cargarLocalidades(provinciaId) {
                try {
                    const response = await fetch(`http://localhost:3000/georef/${provinciaId}`);
                    if (!response.ok) throw new Error('Error al obtener las localidades');
            
                    const localidades = await response.json();
                    const selectLocalidad = document.getElementById('localidad');
                    selectLocalidad.innerHTML = '<option value="">Seleccione una localidad</option>';
            
                    localidades.forEach(localidad => {
                        const option = document.createElement('option');
                        option.value = localidad.id;
                        option.textContent = localidad.nombre;
                        selectLocalidad.appendChild(option);
                    });
            
                    // Inicializar Select2
                    $('#localidad').select2({
                        placeholder: 'Seleccione una localidad',
                        allowClear: true
                    });
            
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            
            
            
            // Cargar provincias al iniciar la página
            document.addEventListener('DOMContentLoaded', cargarProvincias);
            </script>

<script>
    // Función para añadir una sede
    document.getElementById('add-sede-button').addEventListener('click', function() {
        // Validar que idEscuela no sea null
        if (idEscuela !== null) {
            // Obtener valores del formulario
            const direccion = document.getElementById('direccion').value;
            const descripcion = document.getElementById('descripcion').value;
            const provinciaId = document.getElementById('provincia').value; // Asumiendo que el id de la provincia está en el valor del select
            const localidadId = document.getElementById('localidad').value; // Asumiendo que el id de la localidad está en el valor del select

            // Validar que los campos no estén vacíos
            if (direccion && descripcion && provinciaId && localidadId) {
                // Crear un objeto sede
                const nuevaSede = {
                    id_escuela: idEscuela,
                    direccion: direccion,
                    localidad: {
                        id: localidadId,
                        nombre: document.getElementById('localidad').options[document.getElementById('localidad').selectedIndex].text,
                        provincia: provinciaId, // Cambiamos aquí para que sea solo el ID de la provincia
                    },
                };

                // Aquí podrías hacer la llamada POST a tu API para crear la sede, por ejemplo usando fetch:
                fetch('http://localhost:3000/sedes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(nuevaSede),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al crear la sede');
                    }
                    return response.json();
                })
                .then(data => {
                    // Añadir la sede a la lista de sedes en el DOM
                    const sedesList = document.getElementById('sedes-list');
                    const sedeElement = document.createElement('div');
                    sedeElement.textContent = `Sede creada: ${direccion}, ${descripcion}, ${data.localidad.nombre}, ${data.localidad.provincia}`;
                    sedesList.appendChild(sedeElement);

                    // Limpiar los campos del formulario
                    document.getElementById('direccion').value = '';
                    document.getElementById('descripcion').value = '';
                    document.getElementById('provincia').selectedIndex = 0; // Reiniciar el select
                    document.getElementById('localidad').selectedIndex = 0; // Reiniciar el select
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('No se pudo crear la sede. Intenta nuevamente.');
                });
            } else {
                alert('Por favor completa todos los campos.');
            }
        } else {
            alert('El ID de la escuela no puede ser nulo.');
        }
    });
</script>
</body>
</html>









