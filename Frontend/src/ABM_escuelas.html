<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>Unión Mediterránea - Taekwondo IFT</title>
    <link rel="shortcut icon" href="../assets/union.ico" type="image/x-icon">
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="stylesheet" href="../styles/footer.css">
    <link rel="stylesheet" href="../styles/menu.css">
    <link rel="stylesheet" href="../styles/modal_conf.css">
    <link rel="stylesheet" href="../styles/ABM_publicaciones.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
</head>
<style>
.img-circular-container {
    display: flex;
    justify-content: center; /* Centra la imagen horizontalmente */
    margin-top: 10px; /* Espacio entre el input y la imagen */
}

.img-circular {
    width: 250px; /* Ancho de la imagen */
    height: 250px; /* Alto de la imagen */
    border-radius: 50%; /* Hace que la imagen sea circular */
    object-fit: cover; /* Recorta la imagen para que encaje en el contenedor */
    border: 2px solid #ccc; /* Bordes opcionales para la imagen */
}

.container {
    text-align: center;
    max-width: 1500px;
    padding: 50px;
    border-radius: 30px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
    margin: 150px auto;
    flex: 1;
}

.search-filters {
    background-color: #63666B;
    padding: 20px;
    border-radius: 20px;
    margin: 0 auto;
    height: auto;  /* Ajusta la altura automáticamente */
    align-content: center;
}

.filter-row {
    display: flex;
    justify-content: flex-end;  /* Cambiado a 'flex-start' para alinear a la izquierda */
    padding-bottom: 15px;
    margin: 15px;
}

.filter-group {
    flex: 1;
    margin-right: 10px;
}

.filter-group:last-child {
    margin-right: 0;
}

label {
    display: block;
    color: #fff;
    margin-bottom: 5px;
    text-align: initial;
}

input[type="text"],
select {
    width: 100%;
    padding: 16px;
    background-color: #d5d7d8;
    border: none;
    border-radius: 5px;
    font-size: 14px;
}

input[type="text"]:focus,
select:focus {
    outline: none;
}

.search-button {
    background-color: #323232;
    color: white;
    padding: 15px 50px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    text-align: center;
    display: block;
}

.search-button:hover {
    background-color: #f36a2bc2;
}


h2, h3{
    margin: 30px;
    margin-bottom: 30px;
    font-size: 40px;
    text-align: left;
    margin-bottom: 50px;
}
h3{
    color: #D2D2D2;
}




</style>
<body>
    <header class="navbar">
        <div class="navbar-left">
            <a href="../Index.html">
                <img src="../assets/log4.png" alt="Logo" class="navbar-logo">
                <h1 class="navbar-title">PANEL DE ADMINISTRACION</h1>
            </a>
        </div>
        <nav class="navbar-menu" id="navbar-menu">
            <ul>
                <img src="../assets/log1.png" alt="Logo" class="navbar-logo-U">
                <li><a href="publicaciones.html">Publicaciones</a></li>
                <li><a href="ABM_alumnos.html">Mis Alumnos</a></li> 
                <li><a id="actual" href="ABM_escuelas.html">Mi Escuela</a></li>
                <li><a href="mi-perfil.html">Mi Perfil</a></li>
                <li><a href="../src/login.html" class="login-btn">Cerrar Sesión</a></li>
            </ul>
        </nav>
        <i class="fas fa-bars hamburger" id="hamburger"></i>
    </header>       
    <!-- Loader -->
    <!-- <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div> -->
    <div class="alert-container">
        <div id="alert-aviso" class="alert alert-aviso">            
        </div>
        <div id="alert-success" class="alert alert-success">            
        </div>
        <div id="alert-error" class="alert alert-danger">
        </div>
    </div>
    
    <main class="container">
        <h2>Escuela</h2>
        <button class="new-publication" id="openModalButton">Mi Escuela</button>
    
        <!-- Modal personalizado -->
        <div id="newPublicationModal" class="custom-modal">
            <div class="modal-content-custom">
                <div class="modal-header-custom">
                    <h5 class="modal-title">Crear Nueva Escuela</h5>
                    <button class="btn-close-custom" id="closeModalButton">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="publicationForm">
                        <!-- Campo para el logo de la escuela con vista previa -->
                        <div class="mb-3 img-circular-container">
                            <img id="imagePreview" src="../../../backend/default/logo.png" alt="Vista previa" class="img-circular">
                        </div>
    
                        <!-- Campo para el nombre de la escuela -->
                        <div class="mb-3">
                            <label for="titulo" class="form-label">Nombre de la Escuela</label>
                            <input type="text" class="form-control" id="titulo" name="titulo" required>
                        </div>
    
                        <!-- Campo para el logo de la escuela -->
                        <div class="mb-3">
                            <label for="imagen" class="form-label">Cargar Logo de la Escuela</label>
                            <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*" onchange="previewImage(event)">
                        </div>
    
                        <!-- Campo para el email -->
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">Email</label>
                            <input type="email" class="form-control" id="descripcion" name="descripcion" required>
                        </div>
    
                        <!-- Campo para el teléfono -->
                        <div class="mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" required>
                        </div>
    
                        <!-- Campo para el enlace de Instagram -->
                        <div class="mb-3">
                            <label for="enlaceInstagram" class="form-label">Enlace de Instagram</label>
                            <input type="text" class="form-control" id="enlaceInstagram" name="enlaceInstagram" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer-custom">
                    <button type="button" class="btn btn-cancelar" id="closeModalButtonFooter">Cerrar</button>
                    <button type="button" class="btn btn-guardar" id="btnGuardar">Guardar</button>
                </div>
            </div>
        </div>
    
        <!-- Modal de Confirmación -->
        <div id="confirmModal" class="confirmacion-modal">
            <div class="modal-content-confirmacion">
                <div class="modal-header-confirmacion">
                    <h5 class="modal-title">Confirmación</h5>
                    <button class="btn-close-confirmacion" id="closeConfirmModal">&times;</button>
                </div>
                <div class="confirmacion-modal-body">
                    <p id="confirmMessage">¿Estás seguro de realizar esta acción?</p>
                </div>
                <div class="modal-footer-confirmacion">
                    <button type="button" class="btn btn-cancelar" id="cancelConfirmButton">Cancelar</button>
                    <button type="button" class="btn btn-confirmar" id="confirmActionButton">Confirmar</button>
                </div>
            </div>
        </div>

       
        <!-- Formulario reorganizado para crear sedes manteniendo las clases -->
        <section class="search-filters">
            <h3>Sedes</h3>
            <form action="#" method="POST" id="create-sede-form" novalidate>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="direccion">Dirección</label>
                        <input type="text" id="direccion" name="direccion" placeholder="Ingresa la dirección" required />
                    </div>
        
                    <div class="filter-group">
                        <label for="descripcion">Descripción</label>
                        <input type="text" id="descripcion" name="descripcion" placeholder="Ingresa la descripción" required />
                    </div>
                </div>
        
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="provincia">Provincia</label>
                        <select id="provincia" name="provincia" required>
                            <option value="">Selecciona la provincia</option>
                            <!-- Opciones dinámicas de provincias -->
                        </select>
                    </div>
        
                    <div class="filter-group">
                        <label for="localidad">Localidad</label>
                        <select id="localidad" name="localidad" required>
                            <option value="">Selecciona la localidad</option>
                            <!-- Opciones dinámicas de localidades -->
                        </select>
                    </div>
                </div>
        
                <div class="filter-row">
                    <button type="button" id="add-sede-button" class="search-button">Añadir</button>
                </div>
            </form>
        
            <div id="sedes-list"></div>
        </section>
        

    </main>
    

    <footer>
        <div class="footer">
            <div class="footer-content">
                <img src="../assets/union-logo.png" alt="Logo Unión Mediterránea de Taekwondo" class="footer-logo">
                <div class="footer-icons-container">
                    <div class="icon-arrow">
                        <a href="#"><i class="fa-solid fa-arrow-up"></i></a>
                    </div>
                    <div class="footer-icons">
                        <a target="_blank" href="https://www.facebook.com/p/Union-Mediterranea-de-Taekwondo-100063475813834/"><i class="fa-brands fa-facebook"></i></a>
                        <a target="_blank" href="https://www.instagram.com/union_mediterranea/"><i class="fa-brands fa-instagram"></i></a>
                        <a target="_blank" href="#"><i class="fa-brands fa-youtube"></i></a>
                        <a target="_blank" href="https://wa.me/3517014308"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                    <a href="mailto:supportunion@gmail.com" class="footer-email">supportunion@gmail.com</a>
                </div>
                <div class="footer-right">
                    <img src="../assets/fetra-logo.png" alt="Logo Federación Taekwondo" class="footer-logo">
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>UNION MEDITERRANEA DE TAEKWONDO 2024</p>
        </div>
    </footer>

    
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
    <script src="../controllers/public/menu.js"></script>
    
    <script>
        function submitForm() {
    // Obtener el token del almacenamiento local
    const token = localStorage.getItem('authToken');
    if (!token) {
        redirectToLogin('Token no encontrado.');
        return;
    }

    // Decodificar el token para obtener el DNI y otros datos
    const { dni, estado: userStatus, rol } = jwt_decode(token);

    // Obtener los valores del formulario
    const nombre = document.getElementById('titulo').value;
    const email = document.getElementById('descripcion').value;
    const telefono = document.getElementById('telefono').value;
    const enlace = document.getElementById('enlaceInstagram').value;

    // Validar que todos los campos estén llenos
    if (!nombre || !email || !telefono || !enlace) {
        alert('Por favor, complete todos los campos del formulario.');
        return;
    }

    // Crear el objeto que se enviará en el cuerpo del POST
    const data = {
        nombre: nombre,
        dni_instructor: dni, // El DNI que proviene del token decodificado
        email: email,
        telefono: telefono,
        enlace: enlace,
        logo: null // Se deja null por defecto, la imagen se envía por otro endpoint
    };

    // Función para hacer el POST a la API
    async function fetchUserData() {
        try {
            // Imprimir datos antes de enviar
            console.log('Datos a enviar:', data);

            const response = await fetch(`http://localhost:3000/escuelas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` // Asegúrate de que el token es correcto
                },
                body: JSON.stringify(data) // Convertir el objeto a JSON
            });

            // Obtener la respuesta como texto
            const responseText = await response.text();
            console.log('Respuesta del servidor:', responseText); // Imprimir la respuesta en texto

            if (!response.ok) {
                // Si la respuesta no es ok, lanzar un error
                throw new Error('Error en la red: ' + response.statusText + ' - ' + responseText);
            }

            // Aquí puedes manejar la respuesta, como cerrar el modal o mostrar un mensaje de éxito
            if (responseText.includes('Escuela creada con éxito')) {
                console.log('Éxito:', responseText);
                alert(responseText); // Mostrar el mensaje de éxito
            } else {
                alert('Respuesta no esperada: ' + responseText);
            }

        } catch (error) {
            console.error('Error en la petición:', error); // Mostrar el error en la consola
            alert('Se produjo un error al enviar los datos: ' + error.message);
        }
    }

    // Llamar a la función fetch para realizar el POST
    fetchUserData();
}

// Evento para confirmar la acción
confirmActionButton.addEventListener('click', submitForm);

    
    </script>
    <script src="../controllers/controllers-publicaciones/manejo-modales.js"></script>



    <!-- FALTA PROBAR CUANDO SE HAGA EL ENDPOINT GET BY ID INSTRUCTOR -->
    <!--<script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('authToken');
            if (!token) {
                redirectToLogin('Token no encontrado.');
                return;
            }
        
            const { dni } = jwt_decode(token);
        
            // Hacer la solicitud al endpoint de la escuela
            try {
                const response = await fetch(`../../../backend/escuela/${dni}`);
                if (!response.ok) {
                    throw new Error('No se pudo obtener los datos de la escuela');
                }
        
                const escuela = await response.json();
        
                // Si el instructor tiene una escuela registrada, rellenar los campos del formulario
                if (escuela) {
                    document.getElementById('titulo').value = escuela.nombre;
                    document.getElementById('descripcion').value = escuela.email;
                    document.getElementById('telefono').value = escuela.telefono;
                    document.getElementById('enlaceInstagram').value = escuela.enlace;
        
                    // Mostrar el logo de la escuela si existe
                    const logoPath = escuela.logo ? `../../../backend/logos/${escuela.logo}` : '../../../backend/default/logo.png';
                    document.getElementById('imagePreview').src = logoPath;
                }
            } catch (error) {
                console.error('Error al cargar los datos de la escuela:', error);
            }
        });
        
        // Función para mostrar una vista previa de la imagen cargada
        function previewImage(event) {
            const reader = new FileReader();
            reader.onload = function(){
                const imagePreview = document.getElementById('imagePreview');
                imagePreview.src = reader.result;
            }
            reader.readAsDataURL(event.target.files[0]);
        }
        </script>-->
        <script>
            // Función para cargar provincias desde el backend
            async function cargarProvincias() {
                try {
                    const response = await fetch('http://localhost:3000/georef');
                    if (!response.ok) throw new Error('Error al obtener las provincias');
            
                    const provincias = await response.json();
                    const selectProvincia = document.getElementById('provincia');
                    selectProvincia.innerHTML = '<option value="">Seleccione una provincia</option>';
            
                    provincias.forEach(provincia => {
                        const option = document.createElement('option');
                        option.value = provincia.id;
                        option.textContent = provincia.nombre;
                        selectProvincia.appendChild(option);
                    });
            
                    // Evento para cargar localidades cuando se selecciona una provincia
                    selectProvincia.addEventListener('change', async (event) => {
                        const provinciaId = event.target.value;
                        if (provinciaId) await cargarLocalidades(provinciaId);
                    });
            
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            
            // Función para cargar localidades de una provincia
            async function cargarLocalidades(provinciaId) {
                try {
                    const response = await fetch(`http://localhost:3000/georef/${provinciaId}`);
                    if (!response.ok) throw new Error('Error al obtener las localidades');
            
                    const localidades = await response.json();
                    const selectLocalidad = document.getElementById('localidad');
                    selectLocalidad.innerHTML = '<option value="">Seleccione una localidad</option>';
            
                    localidades.forEach(localidad => {
                        const option = document.createElement('option');
                        option.value = localidad.id;
                        option.textContent = localidad.nombre;
                        selectLocalidad.appendChild(option);
                    });
            
                    // Inicializar Select2
                    $('#localidad').select2({
                        placeholder: 'Seleccione una localidad',
                        allowClear: true
                    });
            
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            
            // Manejar el evento de clic en el botón para agregar sede
            const createSedeForm = document.getElementById('create-sede-form');
            const addSedeButton = document.getElementById('add-sede-button');
            const sedesList = document.getElementById('sedes-list');
            
            addSedeButton.addEventListener('click', async () => {
                const direccion = createSedeForm.direccion.value;
                const descripcion = createSedeForm.descripcion.value;
                const provinciaId = createSedeForm.provincia.value;
                const localidadId = createSedeForm.localidad.value;
            
                if (!direccion || !descripcion || !provinciaId || !localidadId) {
                    alert('Por favor, completa todos los campos.');
                    return;
                }
            
                const sedeData = {
                    id_escuela: 1,
                    direccion: direccion,
                    descripcion: descripcion,
                    localidad: { id: localidadId, nombre: "" },
                    provincia: { id: provinciaId, nombre: "" },
                };
            
                try {
                    const response = await fetch('http://localhost:3000/sedes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(sedeData),
                    });
            
                    if (response.ok) {
                        const newSede = await response.json();
                        // Aquí puedes agregar el nuevo elemento a la lista de sedes
                        const sedeElement = document.createElement('div');
                        sedeElement.textContent = `Sede añadida: ${newSede.descripcion}`;
                        sedesList.appendChild(sedeElement);
                    } else {
                        alert('Error al agregar la sede: ' + response.statusText);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Se produjo un error al enviar los datos: ' + error.message);
                }
            });
            
            // Cargar provincias al iniciar la página
            document.addEventListener('DOMContentLoaded', cargarProvincias);
            </script>
</body>
</html>









