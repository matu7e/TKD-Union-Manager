<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../../styles/style.css">
    <link rel="stylesheet" href="../../styles/footer.css">
    <link rel="stylesheet" href="../../styles/menu.css">
    <link rel="stylesheet" href="../../styles/administrador.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <title>Unión Mediterránea - Taekwondo IFT</title>
    <link rel="shortcut icon" href="../../assets/union.ico" type="image/x-icon">
</head>

<style>
    /* Estilo para la tabla */
    .table-container {
    overflow-x: auto;
    margin: 20px 0;
}

.table {
width: 100%;
border-collapse: collapse;
}

.table th, .table td {
text-align: left;
padding: 12px;
border-bottom: 1px solid #ddd;
}

.table th {
background-color: #323232;
color: white;
}

.table-striped tbody tr:nth-child(even) {
background-color: #63666B !important; /* Color de fondo alterno */
}

.table tbody tr:hover {
background-color: #e0e0e0; /* Color al pasar el ratón */
}
.icon-download {
    color: rgba(0, 191, 255, 0.664);
    cursor: pointer; /* Cambia el cursor al pasar el ratón */
    font-size: 25px;
    padding: 0 3px;
}

.icon-download-disabled {
    color: #63666B;
    cursor: not-allowed; /* Cambia el cursor para indicar que no se puede hacer clic */
    font-size: 25px;
    padding: 0 3px;
}

.icon-ban {
    color: #f36b2b;
    cursor: pointer;
    font-size: 25px;
    padding: 0 3px;
}

.icon-add {
    color: rgba(0, 128, 0, 0.664);
    cursor: pointer;
    font-size: 25px;
    padding: 0 3px;
}
select {
    width: 100%;
  padding: 16px;
  background-color: #d5d7d8;
  border: none;
  border-radius: 5px;
  font-size: 14px;
}

select:focus {
    border-color: #f36b2b;
}

select option {
    color: #63666B; /* Ajusta el color de las opciones dentro del select */
}

</style>
<body>
    <header class="navbar">
        <div class="navbar-left">
            <a href="../../Index.html">
                <img src="../../assets/log4.png" alt="Logo" class="navbar-logo">
                <h1 class="navbar-title">PANEL DE ADMINISTRACION</h1>
            </a>
        </div>
        <nav class="navbar-menu" id="navbar-menu">
            <ul>
                <img src="../../assets/log1.png" alt="Logo" class="navbar-logo-U">
                <li><a href="ABM_portal_publico.html">Portal Publico</a></li>
                <li><a href="ABM_publicaciones.html">Publicaciones</a></li>
                <li><a id="actual" href="ABM_alumnos.html">Miembros</a></li>
                <li><a href="ABM_sedes.html">Sedes</a></li>
                <li><a href="../login.html" class="login-btn">Cerrar Sesión</a></li>
            </ul>
        </nav>
        <i class="fas fa-bars hamburger" id="hamburger"></i>
    </header>
    
    <main class="container">
        <h2 class="my-4">MIEMBROS</h2>
        
        <section class="search-filters mb-4">
            <form action="#" method="GET">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" id="nombre" name="nombre" class="form-control" />
                    </div>
                    <div class="filter-group">
                        <label for="apellido">Apellido</label>
                        <input type="text" id="apellido" name="apellido" class="form-control" />
                    </div>
                    <div class="filter-group">
                        <label for="dni">DNI</label>
                        <input type="text" id="dni" name="dni" class="form-control" />
                    </div>
                </div>

                <div class="filter-row">
                    <div class="filter-group">
                        <label for="escuela">Escuela</label>
                        <select id="escuela" name="escuela" >
                            <option value="">Selecciona su escuela</option>
                            <!-- Opciones dinámicas -->
                        </select>   
                    </div>
                    <div class="filter-group">
                        <label for="cinto">Cinto</label>
                        <select id="cinto" name="cinto" >
                            <option value="">Selecciona un cinto</option>
                            <!-- Opciones dinámicas -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="estado">Estado</label>
                        <select id="estado" name="estado" >
                            <option value="">Selecciona un estado</option>
                            <option value="1">Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>
                    
                </div>

                <div class="filter-row right-align">
                    <button type="submit" class="search-button btn btn-primary">Buscar</button>
                    <button type="button" class="clear-button btn btn-secondary" onclick="limpiarFiltros()">Limpiar Filtros</button>
                </div>
            </form>
        </section>
        <section>
            <div class="table-container">
                <table id="miTabla" class="table table-striped table-responsive">
                    <thead>
                        <tr>
                            <th>Documento</th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Telefono</th>
                            <th>Fecha Nacimiento</th>
                            <th>Edad</th>
                            <th>Factor</th>
                            <th>Cinturon</th>
                            <th>Escuela</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas generadas dinámicamente con JavaScript -->
                    </tbody>
                </table>
                <div class="pagination">
                    <div class="records-count">Registros: <span id="totalRegistros">0</span></div>
                    <div>
                        Página:
                        <select id="pageSelect">
                            <option value="1">1</option>
                            <!-- Páginas generadas dinámicamente -->
                        </select>
                        de <span id="totalPaginas"></span>
                    </div>
                    <button class="export-btn btn btn-success" onclick="exportToExcel()">Exportar</button>
                </div>
            </div>
        </section>
    </main>
<!-- Ejemplo de Modal de Confirmación -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <span id="closeConfirmModal" class="close">&times;</span>
        <p id="confirmMessage">¿Está seguro?</p>
        <button id="confirmActionButton">Confirmar</button>
        <button id="cancelConfirmButton">Cancelar</button>
    </div>
</div>

<footer>
    <div class="footer">
        <div class="footer-content">
            <img src="../../assets/union-logo.png" alt="Logo Unión Mediterránea de Taekwondo" class="footer-logo">
            <div class="footer-icons-container">
                <div class="icon-arrow">
                    <a href="#"><i class="fa-solid fa-arrow-up"></i></a>
                </div>
                <div class="footer-icons">
                    <a target="_blank" href="https://www.facebook.com/p/Union-Mediterranea-de-Taekwondo-100063475813834/">
                        <i class="fa-brands fa-facebook"></i>
                    </a>
                    <a target="_blank" href="https://www.instagram.com/union_mediterranea/">
                        <i class="fa-brands fa-instagram"></i>
                    </a>
                    <a target="_blank" href="#"><i class="fa-brands fa-youtube"></i></a>
                    <a target="_blank" href="https://wa.me/3517014308"><i class="fa-brands fa-whatsapp"></i></a>
                </div>
                <a href="mailto:supportunion@gmail.com" class="footer-email">supportunion@gmail.com</a>
            </div>
            <div class="footer-right">
                <img src="../../assets/fetra-logo.png" alt="Logo Federación Taekwondo" class="footer-logo">
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>UNION MEDITERRANEA DE TAEKWONDO 2024</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="../../controllers/public/menu.js"></script>
<script src="../../controllers/controllers-publicaciones/manejo-modales.js"></script>

<script>
    let currentAction = null;
    let currentDni = null;

    function mostrarModalConfirmacion(mensaje, accion, dni = null) {
        const modal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        confirmMessage.textContent = mensaje;
        currentAction = accion;
        currentDni = dni;
        modal.style.display = 'block';
    }

    function cerrarModal() {
        const modal = document.getElementById('confirmModal');
        modal.style.display = 'none';
        currentAction = null;
        currentDni = null;
    }

    document.getElementById('confirmActionButton').addEventListener('click', () => {
        if (currentAction === 'agregar') {
            agregarPrivilegios(currentDni);
        } else if (currentAction === 'baja') {
            registrarBaja(currentDni);
        }
        cerrarModal();
    });

    document.getElementById('closeConfirmModal').addEventListener('click', cerrarModal);
    document.getElementById('cancelConfirmButton').addEventListener('click', cerrarModal);

    function agregarPrivilegios(dni) {
        fetch(`http://localhost:3000/miembros/subirprivilegios/${dni}`, { method: 'PUT' })
            .then(response => {
                if (!response.ok) throw new Error('Error al agregar privilegios.');
                alert('Privilegios agregados con éxito.');
            })
            .catch(error => console.error('Error:', error));
    }

    function registrarBaja(dni) {
        fetch(`http://localhost:3000/miembros/registrarBaja/${dni}`, { method: 'POST' })
            .then(response => {
                if (!response.ok) throw new Error('Error al registrar baja.');
                alert('Baja registrada con éxito.');
            })
            .catch(error => console.error('Error:', error));
    }

    function agregarMiembro(dni) {
        mostrarModalConfirmacion('¿Estás seguro de agregar privilegios a este miembro?', 'agregar', dni);
    }

    function darDeBaja(dni) {
        mostrarModalConfirmacion('¿Estás seguro de dar de baja a este miembro?', 'baja', dni);
    }

    const buscarUrl = 'http://localhost:3000/miembros/buscar';
    let miembros = [];
    let currentPage = 1;
    const registrosPorPagina = 15;

    function calcularEdad(fechaNacimiento) {
        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const mes = hoy.getMonth() - nacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
            edad--;
        }
        return edad;
    }

    function buscarMiembros(e) {
        e.preventDefault();
        const nombre = document.getElementById('nombre').value;
        const apellido = document.getElementById('apellido').value;
        const dni_miembro = document.getElementById('dni').value;
        const id_cinto = document.getElementById('cinto').value;
        const id_escuela = document.getElementById('escuela').value;
        const estado = document.getElementById('estado').value; // 

        const queryParams = new URLSearchParams({
            nombre,
            apellido,
            dni_miembro,
            id_cinto,
            id_escuela,
            estado // Añadir estado a los parámetros de búsqueda
        });


        fetch(`${buscarUrl}?${queryParams}`)
            .then(response => response.ok ? response.json() : Promise.reject('No se encontraron resultados.'))
            .then(data => {
                miembros = data;
                miembros.length ? mostrarPagina(currentPage) : mostrarMensajeNoResultados();
            })
            .catch(error => console.error(error));
    }

    function mostrarMensajeNoResultados() {
        const tableBody = document.querySelector('#miTabla tbody');
        tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No se encontraron resultados.</td></tr>';
        document.getElementById('totalRegistros').textContent = 'Total de Registros: 0';
    }

    function limpiarFiltros() {
        document.querySelectorAll('#nombre, #apellido, #dni, #cinto, #escuela, #estado').forEach(input => input.value = '');
        cargarMiembros();
    }
    

    function mostrarPagina(pagina) {
        const tableBody = document.querySelector('#miTabla tbody');
        tableBody.innerHTML = '';

        const start = (pagina - 1) * registrosPorPagina;
        const end = start + registrosPorPagina;

        miembros.slice(start, end).forEach(miembro => {
            const row = document.createElement('tr');
            const rutaFichaMedica = miembro.ficha_medica ? `../../../Backend/${miembro.ficha_medica}` : '';
            row.innerHTML = `
                <td>${miembro.dni_miembro}</td>
                <td>${miembro.nombre}</td>
                <td>${miembro.apellido}</td>
                <td>${miembro.telefono}</td>
                <td>${new Date(miembro.fecha_nacimiento).toLocaleDateString()}</td>
                <td>${calcularEdad(miembro.fecha_nacimiento)} años</td>
                <td>${miembro.grupo_sanguineo}</td>
                <td>${miembro.cinto || 'Sin cinto'}</td>
                <td>${miembro.escuela || 'Sin escuela'}</td>
                <td>${miembro.activo ? 'Activo' : 'Inactivo'}</td>
                <td>
                    ${miembro.ficha_medica ? 
                        `<a href="${rutaFichaMedica}" download><i class="fa-solid fa-cloud-arrow-down"></i></a>` : 
                        '<i class="fa-solid fa-cloud-arrow-down icon-download-disabled" title="No disponible"></i>'}
                    <i class="fa-solid fa-user-plus" onclick="agregarMiembro(${miembro.dni_miembro})"></i>
                    <i class="fa-solid fa-ban" onclick="darDeBaja(${miembro.dni_miembro})"></i>
                </td>`;
            tableBody.appendChild(row);
        });
    }
</script>


<script>


    // Cargar cintos al select
    document.addEventListener('DOMContentLoaded', () => {
            const cintoSelect = document.getElementById('cinto');
            fetch('http://localhost:3000/cintos')
                .then(response => response.json())
                .then(data => {
                    data.forEach(cinto => {
                        const option = document.createElement('option');
                        option.value = cinto.id_cinto;
                        option.textContent = cinto.descripcion;
                        cintoSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar los cintos:', error);
                });
        });

        // Cargar las escuelas al select
        document.addEventListener('DOMContentLoaded', () => {
            const escuelaSelect = document.getElementById('escuela');
            fetch('http://localhost:3000/escuelas')
                .then(response => response.json())
                .then(data => {
                    data.forEach(escuela => {
                        const option = document.createElement('option');
                        option.value = escuela.id_escuela;
                        option.textContent = escuela.nombre;
                        escuelaSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar las escuelas:', error);
                });
        });

    // Función para mostrar el total de registros
        function mostrarTotalRegistros() {
            const totalRegistros = miembros.length;
            document.getElementById('totalRegistros').textContent = `Total de Registros: ${totalRegistros}`;
        }

        // Función para actualizar el paginador
        function actualizarPaginador() {
            const totalPaginas = Math.ceil(miembros.length / registrosPorPagina);
            document.getElementById('totalPaginas').textContent = totalPaginas;

            const pageSelect = document.getElementById('pageSelect');
            pageSelect.innerHTML = '';

            for (let i = 1; i <= totalPaginas; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                pageSelect.appendChild(option);
            }
        }
        // Cambiar de página
        document.getElementById('pageSelect').addEventListener('change', (event) => {
            currentPage = parseInt(event.target.value);
            mostrarPagina(currentPage);
        });
        // Asignar el evento de búsqueda al formulario
        document.querySelector('.search-filters form').addEventListener('submit', buscarMiembros);

        // Cargar los miembros al inicio
        cargarMiembros();

        // Función para cargar todos los miembros al inicio
        function cargarMiembros() {
            fetch(buscarUrl)
                .then(response => response.json())
                .then(data => {
                    miembros = data;
                    mostrarPagina(currentPage);
                    actualizarPaginador();
                    mostrarTotalRegistros();
                })
                .catch(error => {
                    console.error('Error al cargar los miembros:', error);
                });
        }
    // Función para exportar a Excel solo los resultados actuales de la grilla
    function exportToExcel() {
        const wb = XLSX.utils.book_new(); // Crear un nuevo libro de Excel
        const ws_data = [];

        // Definir los encabezados manualmente
        const headers = [
            'Nro Documento',
            'Nombre',
            'Apellido',
            'Teléfono',
            'Dirección',
            'Email',
            'Fecha de Nacimiento',      
            'Edad',
            'Grupo Sanguíneo',
            'Cinto',
            'Escuela',
            'Estado',
            'Rol'
        ];
        ws_data.push(headers); // Agregar encabezados a la hoja

        // Utilizar los miembros actuales filtrados en la variable 'miembros'
        miembros.forEach(miembro => {
            const rowData = [
            miembro.dni_miembro,
                    miembro.nombre,
                    miembro.apellido,
                    miembro.telefono,
                    miembro.direccion,
                    miembro.email,
                    new Date(miembro.fecha_nacimiento).toLocaleDateString(), // Formato de fecha
                    calcularEdad(miembro.fecha_nacimiento), // Calcula la edad
                    miembro.grupo_sanguineo,
                    miembro.cinto || 'Sin cinto',
                    miembro.escuela || 'Sin escuela',
                    miembro.activo ? 'Activo' : 'Inactivo',
                    miembro.rol
            ];
            ws_data.push(rowData); // Agregar cada fila con datos del miembro
        });

        const ws = XLSX.utils.aoa_to_sheet(ws_data); // Crear hoja con los datos
        XLSX.utils.book_append_sheet(wb, ws, 'Resultados'); // Agregar hoja al libro

        // Descargar el archivo Excel
        XLSX.writeFile(wb, 'resultados_busqueda.xlsx');
    }
</script>

</body>
</html>


document.addEventListener('DOMContentLoaded', () => {
    cargarOpciones('http://localhost:3000/cintos', 'cinto');
    cargarOpciones('http://localhost:3000/escuelas', 'escuela');
    cargarMiembros(); // Cargar miembros al inicio

    // Asignar el evento de búsqueda
    document.querySelector('.search-filters form').addEventListener('submit', buscarMiembros);
    
    // Control del paginador
    document.getElementById('pageSelect').addEventListener('change', (event) => {
        currentPage = parseInt(event.target.value);
        mostrarPagina(currentPage);
    });
});

// Nueva URL para la búsqueda de miembros con filtros
const buscarUrl = 'http://localhost:3000/miembros/buscar';
let miembros = [];
let currentPage = 1;
const registrosPorPagina = 15;

// Función para cargar las opciones de cintos y escuelas
function cargarOpciones(url, selectId) {
    fetch(url)
        .then(response => response.json())
        .then(data => {
            const selectElement = document.getElementById(selectId);
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id_cinto || item.id_escuela;
                option.textContent = item.descripcion || item.nombre;
                selectElement.appendChild(option);
            });
        })
        .catch(error => {
            console.error(`Error al cargar opciones de ${selectId}:`, error);
        });
}

// Función para mostrar los miembros en la tabla
function mostrarPagina(pagina) {
    const tableBody = document.querySelector('#miTabla tbody');
    tableBody.innerHTML = '';

    const start = (pagina - 1) * registrosPorPagina;
    const end = start + registrosPorPagina;
    const miembrosPagina = miembros.slice(start, end);

    miembrosPagina.forEach(miembro => {
        const row = document.createElement('tr');
        const rutaFichaMedica = miembro.ficha_medica ? `../../../Backend/${miembro.ficha_medica}` : '';

        row.innerHTML = `
            <td>${miembro.dni_miembro}</td>
            <td>${miembro.nombre}</td>
            <td>${miembro.apellido}</td>
            <td>${miembro.telefono}</td>
            <td>${new Date(miembro.fecha_nacimiento).toLocaleDateString()}</td>
            <td>${calcularEdad(miembro.fecha_nacimiento)} años</td>
            <td>${miembro.grupo_sanguineo}</td>
            <td>${miembro.cinto || 'Sin cinto'}</td>
            <td>${miembro.escuela || 'Sin escuela'}</td>
            <td>${miembro.activo ? 'Activo' : 'Inactivo'}</td>
            <td>
                ${miembro.ficha_medica 
                    ? `<a href="${rutaFichaMedica}" target="_blank" download>
                        <i class="fa-solid fa-cloud-arrow-down icon-download"></i>
                    </a>`
                    : `<i class="fa-solid fa-cloud-arrow-down icon-download-disabled" title="No hay ficha médica" onclick="alert('Este miembro no tiene ficha médica disponible');"></i>`}
                <i class="fa-solid fa-user-plus icon-add" title="Agregar miembro" onclick="confirmarAgregarMiembro()"></i>
                <i class="fa-solid fa-ban icon-ban" title="Dar de baja" onclick="confirmarDarDeBaja(${miembro.dni_miembro})"></i>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Función para calcular la edad
function calcularEdad(fechaNacimiento) {
    const hoy = new Date();
    const nacimiento = new Date(fechaNacimiento);
    let edad = hoy.getFullYear() - nacimiento.getFullYear();
    const mes = hoy.getMonth() - nacimiento.getMonth();
    if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
    }
    return edad;
}

// Función para buscar miembros
function buscarMiembros(e) {
    e.preventDefault(); // Evita la recarga de la página

    const nombre = document.getElementById('nombre').value;
    const apellido = document.getElementById('apellido').value;
    const dni_miembro = document.getElementById('dni').value;
    const id_cinto = document.getElementById('cinto').value;
    const id_escuela = document.getElementById('escuela').value;
    const estado = document.getElementById('estado').value;

    const queryParams = new URLSearchParams({
        nombre,
        apellido,
        dni_miembro,
        id_cinto,
        id_escuela,
        estado
    });

    fetch(`${buscarUrl}?${queryParams.toString()}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('No se encontraron miembros con los filtros proporcionados.');
            }
            return response.json();
        })
        .then(data => {
            miembros = data;
            if (miembros.length === 0) {
                mostrarMensajeNoResultados();
            } else {
                mostrarPagina(currentPage);
                actualizarPaginador();
                mostrarTotalRegistros();
            }
        })
        .catch(error => {
            console.error('Error en la búsqueda de miembros:', error);
            mostrarMensajeNoResultados();
        });
}

// Función para mostrar mensaje cuando no se encuentran resultados
function mostrarMensajeNoResultados() {
    const tableBody = document.querySelector('#miTabla tbody');
    tableBody.innerHTML = '<tr><td colspan="10" class="text-center">No se encontraron resultados.</td></tr>';
    document.getElementById('totalRegistros').textContent = 'Total de Registros: 0';
    document.getElementById('totalPaginas').textContent = 0; // Actualiza las páginas
}

// Función para limpiar los filtros
function limpiarFiltros() {
    document.getElementById('nombre').value = '';
    document.getElementById('apellido').value = '';
    document.getElementById('dni').value = '';
    document.getElementById('cinto').value = '';
    document.getElementById('escuela').value = '';
    document.getElementById('estado').value = '';
    cargarMiembros();
}

// Función para mostrar el total de registros
function mostrarTotalRegistros() {
    const totalRegistros = miembros.length;
    document.getElementById('totalRegistros').textContent = `Total de Registros: ${totalRegistros}`;
}

// Función para actualizar el paginador
function actualizarPaginador() {
    const totalPaginas = Math.ceil(miembros.length / registrosPorPagina);
    document.getElementById('totalPaginas').textContent = totalPaginas;

    const pageSelect = document.getElementById('pageSelect');
    pageSelect.innerHTML = '';

    for (let i = 1; i <= totalPaginas; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        pageSelect.appendChild(option);
    }
}

// Función para cargar todos los miembros al inicio
function cargarMiembros() {
    fetch(buscarUrl)
        .then(response => response.json())
        .then(data => {
            miembros = data;
            mostrarPagina(currentPage);
            actualizarPaginador();
            mostrarTotalRegistros();
        })
        .catch(error => {
            console.error('Error al cargar los miembros:', error);
        });
}

// Función para abrir el modal de confirmación
function openConfirmModal(mensaje, accion) {
    confirmMessage.textContent = mensaje;
    openModal(confirmModal);

    confirmYes.onclick = () => {
        accion(); // Ejecuta la acción confirmada
        closeModal(confirmModal);
    };
    confirmNo.onclick = () => closeModal(confirmModal);
}

// Función para confirmar agregar miembro
function confirmarAgregarMiembro() {
    openConfirmModal('¿Estás seguro de que deseas agregar este miembro?', agregarMiembro);
}

// Función para confirmar dar de baja
function confirmarDarDeBaja(dni_miembro) {
    openConfirmModal('¿Estás seguro de que deseas dar de baja a este miembro?', () => darDeBaja(dni_miembro));
}

// Función para agregar un miembro (ajusta según tu lógica)
function agregarMiembro() {
    // Implementa la lógica para agregar un miembro aquí
    console.log('Miembro agregado'); // Ejemplo de acción
}

// Función para dar de baja a un miembro (ajusta según tu lógica)
function darDeBaja(dni_miembro) {
    // Implementa la lógica para dar de baja a un miembro aquí
    console.log(`Miembro con DNI ${dni_miembro} dado de baja`); // Ejemplo de acción
}

// Función para exportar a Excel solo los resultados actuales de la grilla
function exportToExcel() {
    const wb = XLSX.utils.book_new(); // Crear un nuevo libro de Excel
    const ws_data = [];

    // Definir los encabezados manualmente
    const headers = [
        'Nro Documento',
        'Nombre',
        'Apellido',
        'Teléfono',
        'Dirección',
        'Email',
        'Fecha de Nacimiento',
        'Edad',
        'Grupo Sanguíneo',
        'Cinto',
        'Escuela',
        'Estado',
        'Ficha Médica'
    ];
    ws_data.push(headers);

    // Recorrer los miembros actuales y agregar los datos a la hoja
    miembros.forEach(miembro => {
        const rowData = [
            miembro.dni_miembro,
            miembro.nombre,
            miembro.apellido,
            miembro.telefono,
            miembro.direccion || 'N/A',
            miembro.email || 'N/A',
            new Date(miembro.fecha_nacimiento).toLocaleDateString(),
            calcularEdad(miembro.fecha_nacimiento),
            miembro.grupo_sanguineo,
            miembro.cinto || 'Sin cinto',
            miembro.escuela || 'Sin escuela',
            miembro.activo ? 'Activo' : 'Inactivo',
            miembro.ficha_medica ? 'Disponible' : 'No disponible'
        ];
        ws_data.push(rowData);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'Miembros');

    // Generar archivo de Excel
    XLSX.writeFile(wb, 'miembros.xlsx');
}

// Asignar evento al botón de limpiar filtros
document.getElementById('limpiar-filtros').addEventListener('click', limpiarFiltros);

// Asignar evento al botón de exportar a Excel
document.getElementById('exportar-excel').addEventListener('click', exportToExcel);























// Variables para la paginación
let publicaciones = [];
let currentPage = 1;
const registrosPorPagina = 15;
const publicacionesUrl = 'http://localhost:3000/publicaciones'; // URL de tus publicaciones

// Obtener elementos de modales y botones
const newPublicationModal = document.getElementById('newPublicationModal');
const confirmModal = document.getElementById('confirmModal');
const openModalButton = document.getElementById('openModalButton');
const closeModalButton = document.getElementById('closeModalButton');
const closeModalButtonFooter = document.getElementById('closeModalButtonFooter');
const closeConfirmModalButton = document.getElementById('closeConfirmModal');
const cancelConfirmButton = document.getElementById('cancelConfirmButton');
const confirmActionButton = document.getElementById('confirmActionButton');

// Estado de acción actual para el modal de confirmación
let currentAction = null;
let currentId = null;

// Función para abrir el modal y bloquear el scroll
function openModal(modal) {
    modal.style.display = 'block';
    document.body.classList.add('no-scroll');
}

// Función para cerrar el modal y restaurar el scroll si todos los modales están cerrados
function closeModal(modal) {
    modal.style.display = 'none';
    const isAnyModalOpen = [newPublicationModal, confirmModal].some(m => m.style.display === 'block');
    if (!isAnyModalOpen) document.body.classList.remove('no-scroll');
}

// Función para cargar todas las publicaciones al iniciar
function cargarPublicaciones() {
    fetch(publicacionesUrl)
        .then(response => response.json())
        .then(data => {
            publicaciones = data;
            mostrarPagina(currentPage);
            actualizarPaginador();
            mostrarTotalRegistros();
        })
        .catch(error => console.error('Error al cargar las publicaciones:', error));
}

function mostrarPagina(pagina) {
    const tableBody = document.querySelector('#miTabla tbody');
    tableBody.innerHTML = '';
    
    const start = (pagina - 1) * registrosPorPagina;
    const end = start + registrosPorPagina;
    const publicacionesPagina = publicaciones.slice(start, end);

    publicacionesPagina.forEach(publicacion => {
        // Valores por defecto si algún campo es nulo o indefinido
        const titulo = publicacion.titulo || '-';
        const descripcion = publicacion.descripcion || '-';
        const enlace = publicacion.enlace ? `<a href="${publicacion.enlace}" target="_blank">Enlace</a>` : '-';
        const fechaPublicacion = publicacion.fecha_publicacion 
            ? new Date(publicacion.fecha_publicacion).toLocaleDateString("es-ES") 
            : '-';
        
        // Verificar si existe una imagen, si no, desactivar el botón de vista previa
        const iconoVerImagen = publicacion.imagen 
            ? `<i class="fa-solid fa-eye icon-view" title="Ver imagen" onclick="verImagen('${publicacion.imagen}')"></i>`
            : '<i class="fa-solid fa-eye icon-view-disabled" title="Imagen no disponible"></i>';

        // Crear la fila con los datos
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${titulo}</td>
            <td>${descripcion}</td>
            <td>${enlace}</td>
            <td>${fechaPublicacion}</td>
            <td>
                ${iconoVerImagen}
                <i class="fa-solid fa-trash icon-delete" title="Eliminar publicación" onclick="confirmarEliminacion(${publicacion.id})"></i>
            </td>
        `;
        tableBody.appendChild(row);
    });
}


// Función para ver la imagen en un modal
function verImagen(imagenPath) {
    const imageModal = document.getElementById('imagePreviewModal');
    const previewImage = document.getElementById('previewImage');
    
    // Limpiar el imagenPath para eliminar caracteres extraños
    const cleanedPath = imagenPath.replace(/{/g, '').replace(/}/g, ''); // Quitar '{' y '}'
    
    // Ajustar la ruta de la imagen
    previewImage.src = `../../../Backend/${cleanedPath}`;
    imageModal.style.display = 'block';
}


// Función para cerrar el modal de imagen
document.getElementById('closeImagePreview').addEventListener('click', () => {
    document.getElementById('imagePreviewModal').style.display = 'none';
});

// Función para cerrar el modal al hacer clic fuera de la imagen
window.addEventListener('click', (event) => {
    const imageModal = document.getElementById('imagePreviewModal');
    if (event.target === imageModal) {
        imageModal.style.display = 'none';
    }
});

// Función para mostrar el total de registros
function mostrarTotalRegistros() {
    const totalRegistros = publicaciones.length;
    document.getElementById('totalRegistros').textContent = `Total de Registros: ${totalRegistros}`;
}

// Función para actualizar el paginador
function actualizarPaginador() {
    const totalPaginas = Math.ceil(publicaciones.length / registrosPorPagina);
    document.getElementById('totalPaginas').textContent = totalPaginas;

    const pageSelect = document.getElementById('pageSelect');
    pageSelect.innerHTML = '';
    for (let i = 1; i <= totalPaginas; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        pageSelect.appendChild(option);
    }
}

// Cambiar de página
document.getElementById('pageSelect').addEventListener('change', (event) => {
    currentPage = parseInt(event.target.value);
    mostrarPagina(currentPage);
});

// Función para mostrar el modal de confirmación de eliminación
function confirmarEliminacion(id) {
    currentAction = 'eliminar';
    currentId = id;
    openModal(confirmModal);
}

// Evento de confirmación en el modal
confirmActionButton.addEventListener('click', () => {
    if (currentAction === 'eliminar') eliminarPublicacion(currentId);
    closeModal(confirmModal);
});

// Función para eliminar publicación
function eliminarPublicacion(id) {
    fetch(`${publicacionesUrl}/${id}`, { method: 'DELETE' })
        .then(response => {
            if (!response.ok) throw new Error('Error al eliminar la publicación.');
            showAlert('success', 'Publicación eliminada con éxito.');
            cargarPublicaciones(); // Actualizar la lista después de eliminar
        })
        .catch(error => console.error('Error al eliminar la publicación:', error));
}

// Función para mostrar alertas
function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    document.body.appendChild(alert);
    setTimeout(() => document.body.removeChild(alert), 3000);
}

// Cargar publicaciones al inicio
document.addEventListener('DOMContentLoaded', cargarPublicaciones);

// Cerrar modales con botones
closeModalButton.addEventListener('click', () => closeModal(newPublicationModal));
closeModalButtonFooter.addEventListener('click', () => closeModal(newPublicationModal));
closeConfirmModalButton.addEventListener('click', () => closeModal(confirmModal));
cancelConfirmButton.addEventListener('click', () => closeModal(confirmModal));
